<main class="container py-5">
  <div class="row g-4 mb-4">
    <div class="col-lg-7">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-uppercase text-muted small mb-1">Welcome back</p>
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
            <div>
              <h1 class="h3 mb-1"><%= volunteer?.name || user?.name || 'Volunteer' %></h1>
              <p class="text-muted mb-0">Status:
                <% if (volunteer?.approvalStatus === 'approved') { %>
                  <span class="badge bg-success-subtle text-success-emphasis">Approved</span>
                <% } else if (volunteer?.approvalStatus === 'rejected') { %>
                  <span class="badge bg-danger-subtle text-danger-emphasis">Rejected</span>
                <% } else { %>
                  <span class="badge bg-warning-subtle text-warning-emphasis text-dark">Pending Review</span>
                <% } %>
                <% if (volunteer?.blocked) { %>
                  <span class="badge bg-danger-subtle text-danger-emphasis">Blocked</span>
                <% } %>
              </p>
            </div>
            <div class="mt-3 mt-md-0 text-md-end">
              <p class="text-muted small mb-1">Location</p>
              <p class="fw-semibold mb-0"><%= volunteer?.volunteerProfile?.currentLocation || 'Not set' %></p>
            </div>
          </div>
          <hr>
          <div class="row g-3">
            <div class="col-sm-6 col-lg-3">
              <div class="stat-card">
                <p class="text-muted small mb-1">Assigned</p>
                <h4 class="mb-0"><%= stats.assigned %></h4>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="stat-card">
                <p class="text-muted small mb-1">In progress</p>
                <h4 class="mb-0"><%= stats.inProgress %></h4>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="stat-card">
                <p class="text-muted small mb-1">Completed</p>
                <h4 class="mb-0 text-success"><%= stats.completed %></h4>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="stat-card">
                <p class="text-muted small mb-1">Overdue</p>
                <h4 class="mb-0 text-danger"><%= stats.overdue %></h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Notifications</h5>
          <ul class="list-unstyled mb-0">
            <li class="d-flex align-items-start gap-2 mb-2">
              <i class="bi bi-info-circle text-primary mt-1"></i>
              <div>
                <strong>Profile</strong>
                <p class="mb-0 text-muted small">Keep your skills & availability updated so coordinators can assign the right missions.</p>
              </div>
            </li>
            <li class="d-flex align-items-start gap-2 mb-2">
              <i class="bi bi-clock-history text-warning mt-1"></i>
              <div>
                <strong>Overdue tasks</strong>
                <p class="mb-0 text-muted small">Complete overdue tasks promptly to avoid automatic warnings.</p>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <% if (alerts?.success) { %>
    <div class="alert alert-success"><%= alerts.success %></div>
  <% } %>
  <% if (alerts?.error) { %>
    <div class="alert alert-danger"><%= alerts.error %></div>
  <% } %>

  <section class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <div>
          <h2 class="h5 mb-1">Assigned Tasks</h2>
          <p class="text-muted small mb-0">Update progress, upload reports, and close assignments.</p>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Task</th>
              <th>Status</th>
              <th>Deadline</th>
              <th>Disaster</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (!tasks.length) { %>
              <tr>
                <td colspan="5" class="text-center text-muted py-4">No tasks assigned yet.</td>
              </tr>
            <% } %>
            <% tasks.forEach(task => { 
              const overdue = task.status !== 'completed' && task.deadline && new Date(task.deadline) < new Date();
            %>
              <tr>
                <td>
                  <div class="fw-semibold"><%= task.title %></div>
                  <% if (task.description) { %>
                    <div class="text-muted small"><%= task.description %></div>
                  <% } %>
                </td>
                <td>
                  <% if (task.status === 'completed') { %>
                    <span class="badge bg-success-subtle text-success-emphasis">Completed</span>
                  <% } else if (task.status === 'in_progress') { %>
                    <span class="badge bg-primary-subtle text-primary-emphasis">In progress</span>
                  <% } else { %>
                    <span class="badge bg-warning-subtle text-dark"><%= overdue ? 'Overdue' : 'Assigned' %></span>
                  <% } %>
                </td>
                <td><%= task.deadline ? new Date(task.deadline).toLocaleDateString() : 'â€”' %></td>
                <td><%= task.disaster?.title || 'General mission' %></td>
                <td class="text-end">
                  <div class="d-flex flex-wrap gap-1 justify-content-end">
                    <% if (task.status === 'assigned') { %>
                      <form action="/volunteer/tasks/<%= task._id %>/status" method="POST">
                        <input type="hidden" name="status" value="in_progress">
                        <button class="btn btn-sm btn-outline-primary">Accept</button>
                      </form>
                    <% } %>
                    <% if (task.status !== 'completed') { %>
                      <form action="/volunteer/tasks/<%= task._id %>/report" method="POST" enctype="multipart/form-data" class="report-form d-none">
                        <input type="hidden" name="taskId" value="<%= task._id %>">
                      </form>
                      <form action="/volunteer/tasks/<%= task._id %>/status" method="POST">
                        <input type="hidden" name="status" value="completed">
                        <button class="btn btn-sm btn-success">Mark Complete</button>
                      </form>
                    <% } %>
                  </div>
                  <details class="mt-2">
                    <summary class="text-muted small">Submit report</summary>
                    <form action="/volunteer/tasks/<%= task._id %>/report" method="POST" enctype="multipart/form-data" class="mt-2">
                      <textarea name="description" class="form-control form-control-sm mb-2" rows="3" placeholder="Describe work completed" required></textarea>
                      <input type="file" name="attachments" class="form-control form-control-sm mb-2" accept=".jpg,.jpeg,.png,.pdf" multiple>
                      <button class="btn btn-sm btn-outline-secondary">Upload report</button>
                    </form>
                  </details>
                  <% if (task.report?.submittedAt) { %>
                    <div class="mt-2 text-muted small">Report submitted <%= new Date(task.report.submittedAt).toLocaleString() %></div>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="card border-0 shadow-sm">
    <div class="card-body">
      <h2 class="h5 mb-3">Activity Timeline</h2>
      <ul class="timeline list-unstyled mb-0">
        <% tasks.slice(0, 6).forEach(task => { %>
          <li class="timeline-item mb-3">
            <div class="d-flex justify-content-between">
              <div>
                <strong><%= task.title %></strong>
                <p class="text-muted small mb-0">Status: <%= task.status %></p>
              </div>
              <small class="text-muted"><%= new Date(task.createdAt).toLocaleDateString() %></small>
            </div>
          </li>
        <% }) %>
        <% if (!tasks.length) { %>
          <li class="text-muted">Activity will appear here once tasks are assigned.</li>
        <% } %>
      </ul>
    </div>
  </section>
</main>
